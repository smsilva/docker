#!/bin/bash
WORK_DIRECTORY="${WORK_DIRECTORY:-/tmp/work}"

# Create a temporary work directory
mkdir -p "${WORK_DIRECTORY?}"

# Docker socket file
DOCKER_SOCKET_FILE="/var/run/docker.sock"
DOCKER_SOCKET_GID=$(stat -c %g ${DOCKER_SOCKET_FILE?})

# Container user and group
CONTAINER_USER_ID=1001
CONTAINER_GROUP_ID=${DOCKER_SOCKET_GID?}

# Change the temporary work directory group.
# It will allow the host user to access and modify the files generated by the container
chown :${CONTAINER_GROUP_ID?} "${WORK_DIRECTORY?}"

# Allow the container user group to access and write into the temporary work directory
# - 644 it's equivalent to: rw-r--r-- (default value)
# - 775 it's equivalent to: rwxrwxr-x
chmod 775 "${WORK_DIRECTORY?}"

declare -A COMMANDS

add_command() {
  COMMANDS[${#COMMANDS[@]}]="${1}"
}

add_command "--rm"
add_command "--user ${CONTAINER_USER_ID?}:${CONTAINER_GROUP_ID?}"
add_command "--env WORK_DIRECTORY=${WORK_DIRECTORY?}"
add_command "--volume ${DOCKER_SOCKET_FILE?}:${DOCKER_SOCKET_FILE?}"
add_command "--volume ${WORK_DIRECTORY?}:${WORK_DIRECTORY?}"
add_command "--group-add ${DOCKER_SOCKET_GID?}"

if [ -t 1 ]; then
  add_command "--interactive"
  add_command "--tty"
fi

INPUT_COMMANDS=${@}

docker run ${COMMANDS[@]} ${INPUT_COMMANDS[@]}
